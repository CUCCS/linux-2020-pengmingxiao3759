

#### 实验5 web 服务器的搭建

###### 实验环境

- win10主机

- ubuntu18.04

- nginx version: nginx/1.14.0 (Ubuntu)

- verynginx

  

###### 安装verynginx、nginx、wordpress、dvwa

- verynginx的安装

    根据官方手册进行安装  [alexazhou/**VeryNginx**](https://github.com/alexazhou/VeryNginx/blob/master/readme_zh.md)

  - 首先克隆verynginx的仓库到ubuntu18虚拟机中，然后进入仓库目录，运行安装语句，即可直接安装 VeryNginx 和 OpenResty。

    ```bash
    git clone https://github.com/alexazhou/VeryNginx.git
    cd VeryNginx
    python install.py install
    ```

  - 根据报错安装需要的依赖，然后重新运行上述语句进行安装(安装的依赖版本号如下)

    ```bash
    libssl1.0-dev/1.0.2n-1ubuntu5.3
    libssl1.0.0/1.0.2n-1ubuntu5.3
    openssl1.0/1.0.2
    libpcre3/2:8.39-9
    libpcre3-dev/2:8.39-9
    build-essential/12.4ubuntu1
    ```

  - 修改`/opt/verynginx/openresty/nginx/conf/nginx.conf`配置文件

    ```bash
    sudo vim /opt/verynginx/openresty/nginx/conf/nginx.conf
    #将user从nginx修改为www-data
    #修改server监听端口为8080
    #保存退出
    ```

  - 在windows主机 host文件中添加一条对应的DNS解析`169.254.134.150  vn.sec.cuc.edu.cn`，即可使用域名访问veryngibx。

  - 启动verynginx，启动完成后，通过web面板对verynginx进行配置，在浏览器中访问`http://vn.sec.cuc.edu.cn//verynginx/index.html:8080` 如果访问成功，证明verynginx已经安装完成。默认用户名和密码是 `verynginx` / `verynginx`。登录之后就可以查看状态，并对配置进行修改。
  
    ![verynginx_log](https://github.com/CUCCS/linux-2020-pengmingxiao3759/raw/job5/job5/img/verynginx_log.PNG)

---

- nginx安装

  - 根据参考资料安装LEMP环境

    [How To Install Linux, Nginx, MySQL, PHP (LEMP stack) on Ubuntu 18.04](https://www.digitalocean.com/community/tutorials/how-to-install-linux-nginx-mysql-php-lemp-stack-ubuntu-18-04)

  - 首先安装nginx

    ```bash
    #安装nginx
    sudo apt install nginx
    
    #修改nginx server端口监听80
    sudo vim /etc/nginx/sites-enabled/default
    
    #修改监听端口为80  并保存退出
     listen 80 default_server;
     
     #启动nginx 
     sudo systemctl start nginx
    ```

    此时使用 ip:80即可访问nginx

  - 安装mysql数据库

    ```bash
    #下载安装mysql数据库
    sudo apt install mysql-server
    #配置mysql用户名密码
    ```

  - 安装php，并配置nginx使用php

    ```bash
    #安装php
    sudo add-apt-repository universe
    sudo apt install php-fpm php-mysql
    
    #修改nginx配置PHP-FPM进程的反向代理配置在nginx服务器上 保存退出
    sudo vim /etc/nginx/sites-enabled/default
    
         location ~ \.php$ {
             include snippets/fastcgi-php.conf;
              fastcgi_pass unix:/var/run/php/php7.2-fpm.sock;
         }
         
     #重新启动nginx使配置生效
     sudo systemctl restart nginx
    ```

---

- wordpress安装

  - 参考资料

    [How To Install WordPress with LEMP on Ubuntu 18.04](https://www.digitalocean.com/community/tutorials/how-to-install-wordpress-with-lemp-on-ubuntu-18-04#step-1-%E2%80%94-creating-a-mysql-database-and-user-for-wordpress)

  

  - 首先讲wordpress4.7安装包下载到 ubuntu18.04

    ```bash
    #首先下载安装包
    sudo wget https://wordpress.org/wordpress-4.7.zip
    
    #解压安装包cd 
    unzip wordpress-4.7.zip
    
    #将解压后的wordpress移到指定路径
    sudo mkdir /var/www/html/wp.sec.cuc.edu.cn
    sudo cp wordpress /var/www/html/wp.sec.cuc.edu.cn
    ```

    

  - wordpress的使用需要数据库支撑 ，在mysql中新建一个数据库用于wordpress

    ```bash
    #下载安装mysql数据库
    sudo apt install mysql-server
    
    #新建一个数据库wordpress
    CREATE DATABASE wordpress DEFAULT CHARACTER SET utf8 COLLATE utf8_unicode_ci;
    
    #新建一个用户 刷新并退出
    GRANT ALL ON wordpress.* TO 'wordpressuser'@'localhost' IDENTIFIED BY 'password';
    FLUSH PRIVILEGES;
    EXIT;
    
    ```

  - 安装php扩展

    ```bash
    sudo apt update
    sudo apt install php-curl php-gd php-intl php-mbstring php-soap php-xml php-xmlrpc php-zip
    
    #重启php-fpm
    sudo systemctl restart php7.2-fpm
    ```

  - 配置nginx

    ```bash
    #修改nginx配置 
    sudo vim /etc/nginx/sites-enabled/default
    
    #将网站根站点修改为wordpress的安装目录 并保存退出
    root /var/www/html/wp.sec.cuc.edu.cn;
    ```

  - 在windows主机 host文件中添加一条对应的DNS解析`169.254.134.150  wp.sec.cuc.edu.cn`，使用url`wp.sec.cuc.edu.cn/wordpress/wp-admin/`访问wordpress进行配置,选择语言，然后连接数据库,设置完wordpress用户名密码即可访问wordpress网站。

    ```bash
    #用户名  wordpressuser
    #密码    password
    #数据库  wordpress
    #IP  127.0.0.1
    ```
    
    ![config-wordpress](https://github.com/CUCCS/linux-2020-pengmingxiao3759/raw/job5/job5/img/config-wordpress.PNG)

---

- 安装DVWA

  - 参考链接

    [How to Install and Configure DVWA Lab on Ubuntu 18.04 server](https://kifarunix.com/how-to-setup-damn-vulnerable-web-app-lab-on-ubuntu-18-04-server/)

  - 安装步骤

    - 首先下载DVWA，并移动到指定文件夹中,执行完毕后  `/var/www/html`文件夹下会有一个DVWA的子文件夹。

      ```bash
      sudo git clone https://github.com/ethicalhack3r/DVWA /tmp/DVWA
      sudo mv /tmp/DVWA /var/www/html
      ```

    - 重命名DVWA中的**/config/config.inc.php.dist**为**/config/config.inc.php**

      ```bash
      sudo cp /var/www/html/DVWA/config/config.inc.php.dist /var/www/html/DVWA/config/config.inc.php
      ```

    - 在mysql为DVWA新建一个用户名, 修改DVWA中的配置,用于连接mysql数据库

      ```bash
      #首先登陆mysql
      #新建一个数据库dvwa
       CREATE DATABASE dvwa DEFAULT CHARACTER SET utf8 COLLATE utf8_unicode_ci;
      
      #新建一个用户dvwauser，分配管理dvwa的权限，设置密码 刷新并退出
       GRANT ALL ON dvwa.* TO 'dvwauser'@'localhost' IDENTIFIED BY 'p@ssw0rd';
       FLUSH PRIVILEGES;
       EXIT;
      #重启mysql生效
      sudo systemctl restart mysql
       
      #打开DVWA的配置文件
       sudo vim /var/www/html/DVWA/config/config.inc.php
       
      #修改配置文件为自己需要的内容 保存退出
       $_DVWA[ 'db_server' ]   = '127.0.0.1';
       $_DVWA[ 'db_database' ] = 'dvwa';
       $_DVWA[ 'db_user' ]     = 'dvwauser';
       $_DVWA[ 'db_password' ] = 'p@ssw0rd';
      ```

    - 修改php的配置

      ```bash
      #查看php版本   php -v    版本为7.2
      
      #修改配置文件 并保存退出
      sudo vim /etc/php/7.2/fpm/php.ini
      
      #设置以下项目
      allow_url_include = on
      allow_url_fopen = on
      safe_mode = off
      magic_quotes_gpc = off
      display_errors = off
      
      #修改完以后重启php-fpm使配置生效
      sudo systemctl restart php7.2-fpm
      ```

    - 设置DVWA文件夹访问权限

      ```bash
      sudo chown -R www-data.www-data /var/www/html/DVWA
      ```

    - 配置nginx 5566端口监听DVWA的访问

      ```bash
      #打开nginx配置文件
      sudo vim /etc/nginx/sites-enabled/default
      
      #添加对应的监听模块
      server {
              listen 5566；
              root /var/www/html/DVWA;
              index index.html setup.php index.htm index.php index.nginx-debian.html;
               location / {
                      try_files $uri $uri/ =404;
                }
              #配置php-fpm反向代理
              location ~ \.php$ {
                      include snippets/fastcgi-php.conf;
                      fastcgi_pass unix:/var/run/php/php7.2-fpm.sock;
              }
          }
      
      #重启nginx使配置生效
      sudo systemctl restart nginx
      ```

    - 此时访问dvwa，显示如下。

      ![dvwa_setup](https://github.com/CUCCS/linux-2020-pengmingxiao3759/raw/job5/job5/img/dvwa_setup.PNG)

      

      在主机hosts文件中增加一条对应的dns解析 `169.254.134.150 dvwa.sec.cuc.edu.cn`,并点击`setup.php`页面下方的**Create/Reset Database**生成需要使用的数据库。如果数据库连接成功，页面会直接重定向到登录页面，如下图，使用 admin/password登录。

      ![dvwa_log](https://github.com/CUCCS/linux-2020-pengmingxiao3759/raw/job5/job5/img/dvwa_log.PNG)

      登录成功页面如下: 

      ![dvwa_loged](https://github.com/CUCCS/linux-2020-pengmingxiao3759/raw/job5/job5/img/dvwa_loged.PNG)



###### 实验要求

- 基本要求实现

  - 首先修改nginx配置，wordpress监听127.0.0.1:80，dvwa监听127.0.0.1:5566。然后在verynginx中配置端口转发。

    - 配置matcher

      ![match_wp](https://github.com/CUCCS/linux-2020-pengmingxiao3759/raw/job5/job5/img/match_wp.PNG)

    - 配置upstream![upstream](https://github.com/CUCCS/linux-2020-pengmingxiao3759/raw/job5/job5/img/upstream.PNG)

    - 配置proxy

      ![proxy](https://github.com/CUCCS/linux-2020-pengmingxiao3759/raw/job5/job5/img/proxy.PNG)

  - 然后修改verynginx配置文件，开启443 端口监听，并配置 wp.sec.cuc.edu.cn证书。重启verynginx使配置生效。

- 基本要求实现截图

  - 在一台主机（虚拟机）上同时配Nginx和VeryNginx

    - VeryNginx作为本次实验的Web App的反向代理服务器和WAF
    - PHP-FPM进程的反向代理配置在nginx服务器上，VeryNginx服务器不直接配置Web站点服务

    配置完成拓扑图如下

    ![tuopu](https://github.com/CUCCS/linux-2020-pengmingxiao3759/raw/job5/job5/img/tuopu.jpg)

    配置文件如下

    [nginx配置文件](https://github.com/CUCCS/linux-2020-pengmingxiao3759/raw/job5/job5/img/default)

    [verynginx配置文件](https://github.com/CUCCS/linux-2020-pengmingxiao3759/raw/job5/job5/img/nginx.conf)

  

  - 使用[Wordpress](https://wordpress.org/)搭建的站点对外提供访问的地址为： https://wp.sec.cuc.edu.cn 和 http://wp.sec.cuc.edu.cn，使用[Damn Vulnerable Web Application (DVWA)](http://www.dvwa.co.uk/)搭建的站点对外提供访问的地址为： http://dvwa.sec.cuc.edu.cn。

    ![http_wp](https://github.com/CUCCS/linux-2020-pengmingxiao3759/raw/job5/job5/img/http_wp.PNG)

  

----

- 安全加固要求

  - 使用IP地址方式均无法访问上述任意站点，并向访客展示自定义的**友好错误提示信息页面-1**

    - 添加matcher

      ![ip_regex](https://github.com/CUCCS/linux-2020-pengmingxiao3759/raw/job5/job5/img/ip_regex.PNG)

    - 添加自定义response

      ![ip_resp](https://github.com/CUCCS/linux-2020-pengmingxiao3759/raw/job5/job5/img/ip_resp.PNG)

    - 添加filter

      ![ip_refuse](https://github.com/CUCCS/linux-2020-pengmingxiao3759/raw/job5/job5/img/ip_refuse.PNG)

    - 结果

      ![ip_refuse_dvwa](https://github.com/CUCCS/linux-2020-pengmingxiao3759/raw/job5/job5/img/ip_refuse_dvwa.PNG)

  - [Damn Vulnerable Web Application (DVWA)](http://www.dvwa.co.uk/)只允许白名单上的访客来源IP，其他来源的IP访问均向访客展示自定义的**友好错误提示信息页面-2**

    - 添加matcher

      ![dv_ip](https://github.com/CUCCS/linux-2020-pengmingxiao3759/raw/job5/job5/img/dv_ip.PNG)

    - 添加自定义response

      ![dvwa_res](https://github.com/CUCCS/linux-2020-pengmingxiao3759/raw/job5/job5/img/dvwa_res.PNG)

    - 添加filter

      ![dv_filter](https://github.com/CUCCS/linux-2020-pengmingxiao3759/raw/job5/job5/img/dv_filter.PNG)

    - 结果

      ![dvwa_white](https://github.com/CUCCS/linux-2020-pengmingxiao3759/raw/job5/job5/img/dvwa_white.PNG)

  - 在不升级Wordpress版本的情况下，通过定制[VeryNginx](https://github.com/alexazhou/VeryNginx)的访问控制策略规则，**热**修复[WordPress < 4.7.1 - Username Enumeratio]()（漏洞复现失败）

    原理：访问指定的Url(wp-json)时，检查cookie中是否有wordpress_logged_inxxx字段（判断用户是否已经登录）

    - 添加matcher

      ![wp_mat](https://github.com/CUCCS/linux-2020-pengmingxiao3759/raw/job5/job5/img/wp_mat.PNG)

    - 添加filter

      ![wp_filter](https://github.com/CUCCS/linux-2020-pengmingxiao3759/raw/job5/job5/img/wp_filter.PNG)

    

  - 通过配置[VeryNginx](https://github.com/alexazhou/VeryNginx)的Filter规则实现对[Damn Vulnerable Web Application (DVWA)](http://www.dvwa.co.uk/)的SQL注入实验在低安全等级条件下进行防护
  
    防护原则：匹配参数中出现的疑似sql注入字符串，如union、select等等
  
    - 添加matcher
  
      ![sql_matcher](https://github.com/CUCCS/linux-2020-pengmingxiao3759/raw/job5/job5/img/sql_matcher.PNG)
  
    - 添加自定义response
  
      ![sql_response](https://github.com/CUCCS/linux-2020-pengmingxiao3759/raw/job5/job5/img/sql_response.PNG)
  
    - 添加filter
  
    ![sql_filter](https://github.com/CUCCS/linux-2020-pengmingxiao3759/raw/job5/job5/img/sql_filter.PNG)
  
  - 结果
  
    ![sql_re](https://github.com/CUCCS/linux-2020-pengmingxiao3759/raw/job5/job5/img/sql_re.PNG)

---

- verynginx配置要求

  - [VeryNginx](https://github.com/alexazhou/VeryNginx)的Web管理页面仅允许白名单上的访客来源IP，其他来源的IP访问均向访客展示自定义的**友好错误提示信息页面-3**

    - 添加matcher

      ![vn_white](https://github.com/CUCCS/linux-2020-pengmingxiao3759/raw/job5/job5/img/vn_white.PNG)

    - 添加自定义response

      ![vn_res](https://github.com/CUCCS/linux-2020-pengmingxiao3759/raw/job5/job5/img/vn_res.PNG)

    - 添加filter

      ![vn_filter](https://github.com/CUCCS/linux-2020-pengmingxiao3759/raw/job5/job5/img/vn_filter.PNG)

    - 结果

      ![vn_re](https://github.com/CUCCS/linux-2020-pengmingxiao3759/raw/job5/job5/img/vn_re.PNG)

  - 通过定制VeryNginx的访问控制策略规则实现：

    - 限制DVWA站点的单IP访问速率为每秒请求数 < 50

    - 限制Wordpress站点的单IP访问速率为每秒请求数 < 20
  
    - 超过访问频率限制的请求直接返回自定义**错误提示信息页面-4**
  
      - 添加自定义response
  
        ![speed_resp](https://github.com/CUCCS/linux-2020-pengmingxiao3759/raw/job5/job5/img/speed_resp.PNG)
  
      - 添加频率限制
  
        ![speed](https://github.com/CUCCS/linux-2020-pengmingxiao3759/raw/job5/job5/img/speed.PNG)
  
      - 结果
  
        此处使用http 泛洪攻击对dvwa网站进行请求，源码使用[https://github.com/D4Vinci/PyFlooder](https://github.com/D4Vinci/PyFlooder)的攻击代码。
    
        ![frequency](https://github.com/CUCCS/linux-2020-pengmingxiao3759/raw/job5/job5/img/frequency.PNG)
    
        配置攻击环境为：
    
        - 虚拟机 attacker为ubuntu16.04  host-only网卡
        - 配置 attacker本地 /etc/hosts/文件添加一条域名解析记录`169.254.134.150 dvwa.sec.cuc.edu.cn`
        - 修改源码修改attack函数访问指定页面`login.php`。
        - 下载PyFlooder，直接进行攻击，攻击语句为 `python pyflooder.py dvwa.sec.cuc.edu.cn 8080 1000`
    - 禁止curl访问
    
      - 添加matcher
    
        ![curl_mat](https://github.com/CUCCS/linux-2020-pengmingxiao3759/raw/job5/job5/img/curl_mat.PNG)
    
      - 添加filter
    
        ![curl_filter](https://github.com/CUCCS/linux-2020-pengmingxiao3759/raw/job5/job5/img/curl_filter.PNG)



​    

###### 参考链接

- https://github.com/CUCCS/linux/tree/master/2017-1/TJY
- https://github.com/CUCCS/linux/tree/master/2017-1/snRNA
- https://github.com/CUCCS/linux/tree/master/2017-1/FitzBC
- https://github.com/CUCCS/linux-2019-jackcily

###### 遇到的问题

- 安装verynginx由于依赖版本问题，导致安装报错

  解决：配置正确的依赖版本

- wordpress动态生成的url 是硬编码的

  wordpress动态生成url，是从数据库中拿出siteurl和用户要访问的页面进行拼接，然后返回给用户用于访问。

  下图是mysql数据库中wordpress的硬编码url

  ![wordpress_domain_error](https://github.com/CUCCS/linux-2019-jackcily/raw/job5/job5/img/wordpress_domain_error.PNG)

  所以下面这种配置居然也可以（成环）

  ![wp_hard_encode](https://github.com/CUCCS/linux-2019-jackcily/raw/job5/job5/img/wp_hard_encode.jpg)

  解决：没有解决，还是有bug。